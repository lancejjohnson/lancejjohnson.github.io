<!doctype html>
<html>
  <head>
    <link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,400italic|Lato:400,700|Merriweather:400,700,400italic' rel='stylesheet' type='text/css'>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>{ :to => self - 30 }  - That's not my job! Extract class refactor</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>


    <div id="main" role="main">
      <header class="devblog-header">
  <h1 class="devblog-title">
    <a href="/">{ :to => self - 30 }</a>
  </h1>
  <h2>One person's journey in developing software.</h2>
  <h3>Lance J Johnson</h3>
</header>

      <h1>That&rsquo;s not my job! The Extract Class Refactor</h1>

<p>I admit it, I&rsquo;m a bit of an idealist. Whether it&rsquo;s painting a room or deadlifting a barbell, I have a bent toward finding the &ldquo;right&rdquo; way to do things. When it comes to code, I get excited by talk of SOLID, design patterns, refactoring, and clean code. Being relatively new to programming, though, there are times when the theory is just over my head. Other times, I understand the theory in principle but have a tough time imagining where it touches my day-to-day code. I recently had an &ldquo;aha&rdquo; moment where one of those principles I understood conceptually finally showed up in my text editor. </p>

<h2>Lots of Private Methods</h2>

<p>It has been said by clean code advocates that private methods in a class may be a &ldquo;code smell&rdquo; indicating your class has more than one responsibility. All of those private methods might be a job that could be moved into their own object, a refactoring called <a href="http://www.refactoring.com/catalog/extractClass.html">Extract Class</a>. I understood the ideas expressed but, until recently, hadn&rsquo;t grasped it in the real world.</p>

<p>My primary responsibility at <a href="https://republicwireless.com/">Republic Wireless</a> is working on an internal web application written with <a href="http://www.padrinorb.com/">the Padrino framework</a>. Unlike most Ruby web applications, I suspect, this app doesn&rsquo;t control any of its data; all of its data comes from a JSON API written in Java. A feature I was working on recently required combining data from two different API resources that could not be directly requested from the API in their combined form. One of the resources had an id related to the second resource, but the two can&rsquo;t be retrieved in a composite way. For the sake of the web app, though, the two resources needed to be related to fit within the current feature request.</p>

<p>The first step, given that I&rsquo;m trying hard to embrace test-driven development, is to write a failing test.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></td><td class="code"><pre><span class="n">describe</span> <span class="no">ProfileInvoice</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">"new_collection"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="c1"># For the sake of brevity, I've excluding some mocking</span>
      <span class="c1"># and json fixture data here.</span>
      <span class="vi">@invoices</span> <span class="o">=</span> <span class="no">ProfileInvoice</span><span class="p">.</span><span class="nf">new_collection</span><span class="p">(</span><span class="ss">data: </span><span class="n">invoice_data</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"attaches profiles to invoice items with an id"</span> <span class="k">do</span>
      <span class="vi">@invoices</span><span class="p">[</span><span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="mi">1</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
        <span class="n">invoice</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="nf">profile</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"does not attach profiles to invoice items without an id"</span> <span class="k">do</span>
      <span class="vi">@invoices</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">invoice_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="nf">profile</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_nil</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"attaches the correct profile to invoice items with an id"</span> <span class="k">do</span>
      <span class="n">invoice_item</span> <span class="o">=</span> <span class="vi">@invoices</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">.</span><span class="nf">first</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">to</span> <span class="n">eql</span> <span class="s2">"abcdef1234"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Hopefully you can see from the test above that each invoice has invoice items, some of which have ids to relate them to profiles, some of which do not. The task is to find those with ids, fetch the profile data for each id from its API, and associate the invoice items and profiles.</p>

<p>Why is this operating on invoices instead of invoice items when we are changing the invoice item and not the invoice? Unfortunately, the API is slow. For performance sake, I wanted to fetch each profile from the server only once&mdash;an in-memory cache of sorts&mdash;and then attach it wherever applicable. As the collection of invoices are likely to have multiple occurrences of the same profile, it makes more sense to operating on the invoice level.</p>

<p>Let&rsquo;s jump ahead to the first implementation with a green result.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">ProfileInvoice</span> <span class="o">&lt;</span> <span class="no">ApiFacade</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_collection</span><span class="p">(</span><span class="n">data</span><span class="p">:)</span>
    <span class="n">attach_profiles!</span><span class="p">(</span><span class="k">super</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">invoice_items</span>
    <span class="vi">@invoice_items</span> <span class="o">||=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">collection</span><span class="p">(</span>
      <span class="n">data</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">,</span>
      <span class="ss">:invoice_item</span>
    <span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">attach_profiles!</span><span class="p">(</span><span class="n">invoices</span><span class="p">)</span>
    <span class="n">invoices</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
      <span class="n">invoice</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice_item</span><span class="o">|</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile_id</span>
          <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">id</span> <span class="o">==</span> <span class="nb">id</span> <span class="p">}</span>
      <span class="n">profile</span> <span class="o">=</span> <span class="no">ProfileFacade</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
        <span class="ss">data: </span><span class="no">ProfileData</span><span class="p">.</span><span class="nf">find_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
      <span class="p">)</span>
      <span class="n">profiles</span> <span class="o">&lt;&lt;</span> <span class="n">profile</span>
    <span class="k">end</span>

    <span class="n">profile</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">profiles</span>
    <span class="vc">@@profiles</span> <span class="o">||=</span> <span class="p">[]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>For brevity, I&rsquo;ll skip explaining <code>new_collection</code> and the <code>invoice_items</code> methods. They are related the parent&rsquo;s class handling of making JSON data into objects with useful APIs.</p>

<p>The real work we&rsquo;re concerned with here is taking place in <code>attach_profiles!</code>. It takes in a collection of <code>invoices</code>, gets the <code>invoice_items</code> for each one, and attaches a <code>profile</code> from the server if the <code>invoice_item</code> has a <code>profile_id</code>. </p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">attach_profiles!</span><span class="p">(</span><span class="n">invoices</span><span class="p">)</span>
  <span class="n">invoices</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
    <span class="n">invoice</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice_item</span><span class="o">|</span>
      <span class="k">if</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile_id</span>
        <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Inside <code>attach_profiles!</code> it calls <code>get_profile</code>. This method tries to retrieve a profile by its id from the class&rsquo;s local cache. If it doesn&rsquo;t find it, it fetches the data from the server, stores it in the cache, and returns the profile.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">unless</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">id</span> <span class="o">==</span> <span class="nb">id</span> <span class="p">}</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="no">ProfileFacade</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="ss">data: </span><span class="no">ProfileData</span><span class="p">.</span><span class="nf">find_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">profiles</span> <span class="o">&lt;&lt;</span> <span class="n">profile</span>
  <span class="k">end</span>

  <span class="n">profile</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>This implementation accomplishes the task we set out to do. The spec passes and we&rsquo;re done! Right?</p>

<h2>Expressive Code Using Extract Method</h2>

<p>The spec is passing and we&rsquo;ve accomplished what we set out to do but the code isn&rsquo;t very expressive. The code is functional but it doesn&rsquo;t really tell someone reading the code what it <em>does</em>. Let&rsquo;s make the code more expressive by extracting some methods.</p>

<p>Let&rsquo;s look at <code>attach_profiles!</code> first. The first step in that method is to loop through the <code>invoices</code>. But what is the method <em>doing</em> during that loop? It&rsquo;s adding profiles to invoice items. Let&rsquo;s extract a method called&hellip;wait for it&hellip;<code>add_profiles_to_invoice_items!</code></p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_profiles_to_invoice_items!</span><span class="p">(</span><span class="n">invoice_items</span><span class="p">)</span>
  <span class="n">invoice_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice_item</span><span class="o">|</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile_id</span>
      <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile</span> <span class="o">=</span> <span class="n">profile_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Here we&rsquo;ve moved the code from within the loop in <code>attach_profiles!</code> into this new method. It accepts a collection of <code>invoice_items</code> and does the work of adding the profile to the applicable invoice items. We need to update <code>attach_profiles</code> to call this within its loop.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">attach_profiles!</span><span class="p">(</span><span class="n">invoices</span><span class="p">)</span>
  <span class="n">invoices</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
    <span class="n">add_profiles_to_invoice_items!</span><span class="p">(</span><span class="n">invoice</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>The spec is still green so we&rsquo;re good to go. But we can see now that <code>add_profiles_to_invoice_items!</code> could use the same refactoring. It loops through a collection of <code>invoice_items</code> but what does it <em>do</em>? It adds a profile to an invoice item. Let&rsquo;s create another method.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_profile_to_invoice_item!</span><span class="p">(</span><span class="n">invoice_item</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile_id</span>
    <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>This method accepts an invoice item and adds a profile to it when applicable. Let&rsquo;s update <code>add_profiles_to_invoice_items!</code> to call our new method.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_profiles_to_invoice_items!</span><span class="p">(</span><span class="n">invoice_items</span><span class="p">)</span>
  <span class="n">invoice_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice_item</span><span class="o">|</span>
    <span class="n">add_profile_to_invoice_item!</span><span class="p">(</span><span class="n">invoice_item</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>We now have three methods to accomplish what we were doing in the original <code>attach_profiles!</code> method. </p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">attach_profiles!</span><span class="p">(</span><span class="n">invoices</span><span class="p">)</span>
  <span class="n">invoices</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
    <span class="n">add_profiles_to_invoice_items!</span><span class="p">(</span><span class="n">invoice</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_profiles_to_invoice_items!</span><span class="p">(</span><span class="n">invoice_items</span><span class="p">)</span>
  <span class="n">invoice_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice_item</span><span class="o">|</span>
    <span class="n">add_profile_to_invoice_item!</span><span class="p">(</span><span class="n">invoice_item</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_profile_to_invoice_item!</span><span class="p">(</span><span class="n">invoice_item</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile_id</span>
    <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>It is now more clear, I hope, what each part of the code is actually <em>doing</em>, making the code easier to reason about when a future me or another programmer is reading the code. There are still a few things in <code>add_profiles_to_invoice_item!</code> that could be cleaned up and I dislike having two methods with names that differ by one letter but we&rsquo;re going to leave those for now.</p>

<p>Let&rsquo;s take a look at our other primary method: <code>get_profile</code>. It, too, can use some Extract Method refactoring. Rather than walking through each step this time, I&rsquo;ll just so you the result.</p>

<p>Here is the orignal method:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">unless</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">profiles</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">id</span> <span class="o">==</span> <span class="nb">id</span> <span class="p">}</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="no">ProfileFacade</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="ss">data: </span><span class="no">ProfileData</span><span class="p">.</span><span class="nf">find_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">profiles</span> <span class="o">&lt;&lt;</span> <span class="n">profile</span>
  <span class="k">end</span>

  <span class="n">profile</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Here is the result of extracting methods.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">profile_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="n">profiles</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">id</span> <span class="o">==</span> <span class="nb">id</span> <span class="p">}</span> <span class="o">||</span> <span class="n">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="n">profile</span> <span class="o">=</span> <span class="no">ProfileFacade</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">data: </span><span class="no">ProfileData</span><span class="p">.</span><span class="nf">find_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
  <span class="n">cache_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">cache_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
  <span class="n">profile</span><span class="p">.</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="n">profiles</span> <span class="o">&lt;&lt;</span> <span class="nb">p</span> <span class="p">}</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>I&rsquo;ve changed the &ldquo;gateway&rdquo; method from <code>get_profile</code> to <code>profile_by_id</code>. The latter now returns either the <code>profile</code> from the cache or calls the server fetching method. <code>get_profile</code> fetches the <code>profile</code> data from the server and passes it through <code>cache_profile</code>. <code>cache_profile</code> adds the <code>profile</code> to the cache before returning the <code>profile</code>.</p>

<p>We&rsquo;ve now refactored the two primary methods into six methods, clarifying the intention of each part of the code. Let&rsquo;s take a look at the whole now that we&rsquo;ve refactored by extracting methods.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">ProfileInvoice</span> <span class="o">&lt;</span> <span class="no">ApiFacade</span>
  <span class="c1">#...</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">attach_profiles!</span><span class="p">(</span><span class="n">invoices</span><span class="p">)</span>
    <span class="n">invoices</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
      <span class="n">add_profiles_to_invoice_items!</span><span class="p">(</span><span class="n">invoice</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_profiles_to_invoice_items!</span><span class="p">(</span><span class="n">invoice_items</span><span class="p">)</span>
    <span class="n">invoice_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice_item</span><span class="o">|</span>
      <span class="n">add_profile_to_invoice_item!</span><span class="p">(</span><span class="n">invoice_item</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_profile_to_invoice_item!</span><span class="p">(</span><span class="n">invoice_item</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile_id</span>
      <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile</span> <span class="o">=</span> <span class="n">profile_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">profile_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">profiles</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">id</span> <span class="o">==</span> <span class="nb">id</span> <span class="p">}</span> <span class="o">||</span> <span class="n">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="no">ProfileFacade</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">data: </span><span class="no">ProfileData</span><span class="p">.</span><span class="nf">find_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
    <span class="n">cache_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">cache_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
    <span class="n">profile</span><span class="p">.</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="n">profiles</span> <span class="o">&lt;&lt;</span> <span class="nb">p</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">profiles</span>
    <span class="vc">@@profiles</span> <span class="o">||=</span> <span class="p">[]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<h2>Extract Class</h2>

<p>Stepping back from the editor, I noticed that I now have several methods all of which are private. Here was my &ldquo;aha&rdquo; moment. As mentioned above, private methods may be a &ldquo;code smell&rdquo; telling you that (1) your class has more than one responsibility (i.e. it violates Single Responsibility Principle); and (2) could possibly be &ldquo;fixed&rdquo; by the Extract Class refactoring. In other words, all of the private methods are doing a job unrelated to the real job of that class. They can be move into their own object and the original object can call an instance of the new object instead of self.</p>

<p>Our first step is to pull out all of the private methods into a new class. But what to name the new class? What job is being done by these methods? They are attaching profiles to the invoice items of invoices. Let&rsquo;s name the class for its job: <code>AttachesProfilesToInvoices</code></p>

<p>Here is our new class with all of the private methods from <code>ProfileInvoice</code>:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">AttachesProfilesToInvoices</span>
  <span class="k">def</span> <span class="nf">attach_profiles!</span><span class="p">(</span><span class="n">invoices</span><span class="p">)</span>
    <span class="n">invoices</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
      <span class="n">add_profiles_to_invoice_items!</span><span class="p">(</span><span class="n">invoice</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add_profiles_to_invoice_items!</span><span class="p">(</span><span class="n">invoice_items</span><span class="p">)</span>
    <span class="n">invoice_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice_item</span><span class="o">|</span>
      <span class="n">add_profile_to_invoice_item!</span><span class="p">(</span><span class="n">invoice_item</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_profile_to_invoice_item!</span><span class="p">(</span><span class="n">invoice_item</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile_id</span>
      <span class="n">invoice_item</span><span class="p">.</span><span class="nf">profile</span> <span class="o">=</span> <span class="n">profile_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">profile_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">profiles</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">id</span> <span class="o">==</span> <span class="nb">id</span> <span class="p">}</span> <span class="o">||</span> <span class="n">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_profile</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">klass</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">data: </span><span class="n">data_source</span><span class="p">.</span><span class="nf">find_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
    <span class="n">cache_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">cache_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
    <span class="n">profile</span><span class="p">.</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="n">profiles</span> <span class="o">&lt;&lt;</span> <span class="nb">p</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">profiles</span>
    <span class="vi">@profiles</span> <span class="o">||=</span> <span class="p">[]</span>
  <span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Now we need to update <code>ProfileInvoice</code> to use the new class instead of calling into self.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">ProfileInvoice</span> <span class="o">&lt;</span> <span class="no">ApiFacade</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_collection</span><span class="p">(</span><span class="n">data</span><span class="p">:)</span>
    <span class="n">attacher</span> <span class="o">=</span> <span class="no">AttachesProfilesToInvoices</span><span class="p">.</span><span class="nf">new</span>
    <span class="n">attacher</span><span class="p">.</span><span class="nf">attach_profiles!</span><span class="p">(</span><span class="k">super</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">invoice_items</span>
    <span class="vi">@invoice_items</span> <span class="o">||=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">collection</span><span class="p">(</span>
      <span class="n">data</span><span class="p">.</span><span class="nf">invoice_items</span><span class="p">,</span>
      <span class="ss">:invoice_item</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Now <code>ProfileInvoice</code> isn&rsquo;t doing the job of attaching profiles to invoices. It delegates that responsibility to another object who does that job.</p>

<p>In addition to moving toward the Single Responsibility Principle, this Extract Class refactoring now allows us to inject <code>ProfileInvoice</code>&rsquo;s dependency (though I haven&rsquo;t done that here). If we ever need to change the algorithm by which profiles are attached to invoice items, we can just inject a new object with the same interface and <code>ProfileInvoice</code> is none the wiser. It can go on happily doing its job without having to change.</p>

<h2>Recap of What We Did</h2>

<p>We started designing a class that needs to fetch data from a server as infrequently as possible and attach that data to another object to which it is not &ldquo;naturally&rdquo; related in the API. Our first implementation worked but wasn&rsquo;t the most expressive code; we would have to think through what the code was actually doing each time we read it. We made the code more expressive by extracting methods whose names describe what the method is actually doing. Once we extracted those methods, it was clear there was more going on than the main responsibility of this class. We responded by moving all of those methods&mdash;that responsibility&mdash;into a new class whose sole job is to do that work. Finally, we updated our original object to delegate to the new class.</p>

<p>There are still things we can do to improve this code. Actually injecting the attacher object into the <code>ProfileInvoice</code> would be an improvement. Making the methods inside attacher more distinguishable by name could be useful. Moving the caching of profiles into its own object could also be an improvement, perhaps one that would allow doing all of this on the invoice item level. But the real thing I wanted to explore, the real &ldquo;aha&rdquo; moment for me, was seeing a bunch of private methods as an opportunity to extract another object.</p>

<p>Katrina is right! <a href="http://www.kytrinyx.com/talks/therapeutic-refactoring">Refactoring is therapeutic!</a>.</p>

      <footer>
  <ul class="large-column">
    <li>
      <h5 class="heading">
        Recent Articles
      </h5>
    </li>
    <li>
      <ol>
          <li>
          <a href="/2015/07/14/getting-in-touch-with-anima/">Getting in Touch with Anima</a>
          <span>Jul 14</span>
          </li>
          <li>
          <a href="/2015/07/13/rspec-let-referencing-another-let/">RSpec let Referencing Another let</a>
          <span>Jul 13</span>
          </li>
          <li>
          <a href="/2015/04/13/not-my-job/">That's not my job! Extract class refactor</a>
          <span>Apr 13</span>
          </li>
          <li>
          <a href="/2015/04/02/why-blog/">Why blog</a>
          <span>Apr  2</span>
          </li>
          <li>
          <a href="/2015/04/01/me-write-a-developer-blog-no-way/">Me?! Write a developer blog?! No way!</a>
          <span>Apr  1</span>
          </li>
      </ol>
    </li>
  </ul>

  <ul class="small-column">
    <li>
      <h5 class="heading">
        Tags
      </h5>
    </li>
    <li>
      <ol>
          <li>
          <a href="/tags/blogging/">blogging (2)</a>
          </li>
          <li>
          <a href="/tags/refactoring/">refactoring (1)</a>
          </li>
          <li>
          <a href="/tags/extract-class/">extract class (1)</a>
          </li>
          <li>
          <a href="/tags/code-smells/">code smells (1)</a>
          </li>
          <li>
          <a href="/tags/rspec/">rspec (1)</a>
          </li>
          <li>
          <a href="/tags/testing/">testing (1)</a>
          </li>
          <li>
          <a href="/tags/json/">json (1)</a>
          </li>
      </ol>
    </li>
  </ul>
</footer>

    </div>

  </body>
</html>
